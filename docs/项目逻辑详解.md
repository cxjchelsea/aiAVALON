# AI阿瓦隆多智能体系统 - 项目逻辑详解

## 目录
1. [项目概述](#项目概述)
2. [整体架构](#整体架构)
3. [核心模块详解](#核心模块详解)
4. [智能体运行逻辑](#智能体运行逻辑)
5. [决策逻辑详解](#决策逻辑详解)
6. [游戏流程](#游戏流程)
7. [信息流与状态管理](#信息流与状态管理)

---

## 项目概述

这是一个基于多智能体的阿瓦隆（Avalon）游戏系统。每个智能体能够：
- 动态适应不同角色（梅林、派西维尔、刺客等）
- 基于贝叶斯推理更新对其他玩家身份的信念
- 使用LLM策略引擎进行智能决策（所有决策均由大语言模型完成）
- 生成有策略目的的发言（由LLM生成自然语言发言）

### 核心特点
- **多智能体架构**：每个玩家对应一个独立的智能体实例
- **动态信念系统**：基于游戏行为实时更新对其他玩家的判断
- **LLM策略引擎**：所有决策（队伍提议、投票、任务投票、刺杀、发言）均由大语言模型完成
- **信息过滤机制**：每个智能体只能看到符合其角色能力的信息
- **流局保护机制**：避免因过度拒绝导致坏人直接获胜
- **多LLM支持**：支持OpenAI、DeepSeek、本地Qwen等多种模型

---

## 整体架构

### 系统层次结构

```
┌─────────────────────────────────────────┐
│         主程序入口 (main.py)            │
│  - 游戏初始化                           │
│  - 环境变量配置                         │
│  - 游戏循环控制                         │
└──────────────┬──────────────────────────┘
               │
       ┌───────┴───────┐
       │               │
┌──────▼──────┐ ┌─────▼──────┐
│ 游戏引擎层   │ │ 智能体层    │
│ (game/)     │ │ (agent/)   │
├─────────────┤ ├────────────┤
│ GameEngine  │ │ BaseAgent  │
│ - 状态管理  │ │ - 角色管理  │
│ - 规则执行  │ │ - 决策接口  │
│ - 信息过滤  │ │ - 信念系统  │
│ - 胜负判定  │ │ - 策略引擎  │
└─────────────┘ └────────────┘
```

### 模块职责划分

#### 1. 游戏引擎层 (`src/game/`)
- **`game_engine.py`**: 中央游戏引擎，负责游戏状态管理、角色分发、信息过滤
- **`rules.py`**: 游戏规则定义（任务配置、游戏阶段、阵营等）
- **`roles.py`**: 角色定义和能力（谁能看到谁）
- **`langgraph_game.py`**: 可选的LangGraph状态图管理

#### 2. 智能体层 (`src/agent/`)
- **`base_agent.py`**: 智能体基类，整合所有核心模块
- **`belief_system.py`**: 动态信念系统，基于贝叶斯推理
- **`strategy.py`**: 策略相关类型定义（Personality, DecisionContext等）
- **`llm_strategy.py`**: LLM策略引擎（必需），使用大语言模型完成所有决策
- **`communication.py`**: 沟通生成器（已废弃，现由LLM生成发言）

---

## 核心模块详解

### 1. 游戏引擎 (GameEngine)

#### 1.1 核心组件

**GameState（游戏状态）**
```python
- players: 所有玩家列表
- current_phase: 当前游戏阶段（讨论/投票/任务/刺杀）
- current_round: 当前任务轮次
- current_leader: 当前队长ID
- mission_configs: 任务配置列表
- mission_results: 任务结果历史
- proposed_team: 当前提议的队伍
- votes: 投票记录
- vote_round: 投票轮次（同一任务最多5次）
- successful_missions: 成功任务数
- failed_missions: 失败任务数
```

**RoleDistributor（角色分发器）**
- 根据玩家数量随机分配角色
- 5人局：梅林、派西维尔、忠臣、刺客、莫甘娜
- 6-10人局：根据标准配置分配

**InformationFilter（信息过滤器）**
- **核心功能**：控制每个智能体接收到的信息范围
- **实现原理**：根据角色的`can_see()`方法决定可见玩家
- **信息分级**：
  - 自己：完全信息（角色、阵营）
  - 可见玩家：根据角色能力显示（阵营或"可能是梅林"）
  - 不可见玩家：仅基本信息（ID、名字）

**WinConditionChecker（胜负判定器）**
- 好人获胜：完成3个任务且梅林未被刺杀
- 坏人获胜：破坏3个任务，或成功刺杀梅林，或流局5次

#### 1.2 关键方法

**`get_player_info(player_id)`**
- 返回该玩家的私有信息（可见玩家列表、角色信息等）
- 每个玩家看到的信息不同（信息不对称）

**`propose_team(leader_id, team_members)`**
- 队长提议队伍
- 验证队伍大小是否符合任务配置
- 切换到投票阶段

**`vote_on_team(player_id, approve)`**
- 收集玩家投票
- 所有玩家投票后调用`process_voting_result()`

**`process_voting_result()`**
- 统计同意/拒绝票数
- 通过：进入任务执行阶段，重置投票轮次
- 未通过：增加投票轮次，更换队长，重新讨论
- 流局保护：第5次投票必须通过，否则坏人直接获胜

**`submit_mission_result(mission_votes)`**
- 统计任务结果（成功/失败）
- 更新成功/失败任务计数
- 检查游戏结束条件
- 进入下一轮或刺杀阶段

### 2. 智能体基类 (BaseAgent)

#### 2.1 初始化流程

```python
1. 创建BaseAgent实例
   - 设置玩家ID、名字
   - 初始化人格特质（随机选择或指定）
   - 设置LLM配置（如果启用）

2. 游戏引擎调用 initialize_role()
   - 设置角色类型、阵营
   - 获取私有信息（可见玩家列表）
   - 初始化核心模块：
     * BeliefSystem（信念系统）
     * StrategyEngine（规则引擎）或LLMStrategyEngine（LLM引擎）
     * CommunicationGenerator（沟通生成器）
```

#### 2.2 核心接口

**`propose_team(game_state)`**
- 队长调用，决定提议的队伍成员
- 输入：游戏状态（包含任务配置、信念系统等）
- 输出：队伍成员ID列表

**`vote_on_team(game_state, proposed_team)`**
- 对提议的队伍投票
- 输入：游戏状态、提议的队伍
- 输出：True（同意）/ False（拒绝）

**`vote_on_mission(game_state, mission_team)`**
- 任务执行投票（成功/失败）
- 好人：总是投成功
- 坏人：根据策略决定是否破坏

**`assassinate(game_state)`**
- 刺客专用，选择刺杀目标
- 输入：游戏状态
- 输出：目标玩家ID

**`generate_speech(game_state, recent_speeches)`**
- 生成发言内容
- 输入：游戏状态、最近发言记录
- 输出：发言文本

### 3. 信念系统 (BeliefSystem)

#### 3.1 数据结构

**PlayerBelief（玩家信念）**
```python
- player_id: 玩家ID
- name: 玩家名字
- team_probabilities: 阵营概率 {GOOD: 0.7, EVIL: 0.3}
- role_probabilities: 角色概率（可选）
- trust_score: 信任度 (0-1)
- behavior_history: 行为历史记录
```

#### 3.2 初始化逻辑

**基于可见信息初始化**
1. **自己**：确定身份（好人=1.0，坏人=0.0）
2. **可见玩家**：
   - 梅林视角：看到坏人阵营 → 坏人概率0.9
   - 派西维尔视角：看到"可能是梅林" → 好人概率0.6
   - 坏人视角：看到队友 → 坏人概率0.9
3. **不可见玩家**：
   - 使用先验概率（根据游戏配置计算坏人数量）
   - 坏人概率 = 坏人数量 / 未知玩家数量

#### 3.3 信念更新机制

**`update_belief_from_vote()`**
- 根据投票行为更新信念
- 好人视角：
  - 在队伍中拒绝 → 可疑（坏人概率×1.2）
  - 不在队伍中拒绝 → 可疑（坏人概率×1.1）
  - 同意 → 可能是好人（好人概率×1.05-1.1）

**`update_belief_from_mission()`**
- 根据任务结果更新信念
- **关键推理规则**：
  - 任务失败 + 投失败票 → 很可能是坏人（坏人概率×1.5）
  - 任务失败 + 投成功票 → 可能是好人（好人概率×1.2）
  - 任务成功 → 队伍中可能都是好人（好人概率×1.1）

**`update_belief_from_speech()`**
- 根据发言内容更新信念（当前为简化实现）

#### 3.4 信念查询方法

**`get_most_trusted_players(count)`**
- 按信任度排序，返回最信任的玩家

**`get_most_suspicious_players(count)`**
- 按坏人概率排序，返回最可疑的玩家

---

## 智能体运行逻辑

### 1. 智能体生命周期

```
初始化阶段
    ↓
角色分配
    ↓
信念系统初始化（基于可见信息）
    ↓
游戏循环
    ├─ 讨论阶段 → 生成发言
    ├─ 投票阶段 → 投票决策
    ├─ 任务阶段 → 任务投票
    └─ 刺杀阶段 → 刺杀决策
    ↓
信念系统更新（基于行为）
    ↓
下一轮循环
```

### 2. 决策流程

#### 2.1 队伍提议决策流程

```
队长调用 propose_team()
    ↓
构建 DecisionContext（决策上下文）
    ├─ 游戏阶段
    ├─ 当前轮次
    ├─ 成功/失败任务数
    ├─ 投票轮次
    └─ 任务配置
    ↓
LLMStrategyEngine.decide_team_proposal()
    ├─ 构建游戏上下文描述
    ├─ 构建角色信息描述
    ├─ 构建可见信息描述
    ├─ 构建任务历史描述（关键推理依据）
    ├─ 调用LLM生成决策
    └─ 解析JSON返回队伍
    ↓
返回队伍成员ID列表
```

#### 2.2 投票决策流程

```
玩家调用 vote_on_team()
    ↓
构建 DecisionContext
    ↓
LLMStrategyEngine.decide_vote()
    ├─ 构建游戏上下文（包含任务历史）
    ├─ 分析队伍组成
    ├─ 考虑流局风险（vote_round >= 4 必须同意）
    ├─ 分析信念系统中的玩家判断
    └─ LLM推理决策
    ↓
返回 True（同意）/ False（拒绝）
```

#### 2.3 任务投票决策流程

```
任务成员调用 vote_on_mission()
    ↓
构建 DecisionContext
    ↓
检查阵营
    ├─ 好人 → 总是返回 True（成功）
    │
    └─ 坏人 → LLMStrategyEngine.decide_mission_vote()
        ├─ 分析当前局势
        ├─ 考虑隐藏身份需求
        ├─ 分析任务历史
        └─ LLM推理决策
    ↓
返回 True（成功）/ False（失败）
```

### 3. 信念系统更新流程

```
任务执行完成
    ↓
遍历所有任务成员
    ↓
对每个成员调用 update_belief_from_mission()
    ├─ 检查任务结果
    ├─ 检查该成员的投票（成功/失败）
    ├─ 根据阵营视角更新概率
    │   ├─ 好人视角：
    │   │   ├─ 任务失败 + 投失败 → 坏人概率×1.5
    │   │   └─ 任务失败 + 投成功 → 好人概率×1.2
    │   └─ 坏人视角：
    │       └─ 投失败 → 可能是队友（坏人概率×1.2）
    └─ 归一化概率
    ↓
更新信任度
    ├─ 好人概率 > 0.7 → 信任度 +0.1
    └─ 坏人概率 > 0.7 → 信任度 -0.1
```

---

## 决策逻辑详解

**注意：系统现在仅使用LLM策略引擎，所有决策均由大语言模型完成。**

### LLM策略引擎决策逻辑

#### 1.1 LLM决策流程

**上下文构建**
1. **游戏状态描述**
   - 当前阶段、轮次
   - 成功/失败任务数
   - 投票轮次（关键：流局风险）
   - 当前队长

2. **任务历史描述（关键推理依据）**
   - 每轮任务的队伍组成
   - 任务结果（成功/失败）
   - 失败票数（关键信息！）
   - **推理提示**：
     - 失败票数 = 队伍人数 → 所有人都是坏人
     - 失败票数 > 0 → 队伍中有坏人

3. **信念系统描述**
   - 每个玩家的好人/坏人概率
   - 信任度评分

4. **可见信息描述**
   - 梅林：能看到哪些坏人
   - 派西维尔：能看到"可能是梅林"的玩家
   - 坏人：能看到哪些队友

5. **角色信息描述**
   - 角色能力
   - 阵营目标
   - 特殊注意事项

**Prompt构建**
- System Prompt：角色信息、游戏规则、关键推理规则
- User Prompt：游戏上下文、决策任务、输出格式要求

**输出解析**
- 期望JSON格式：`{"reasoning": "...", "decision": ...}`
- 移除可能的markdown代码块标记
- 验证决策有效性
- 如果LLM调用失败，抛出错误（不再有回退策略）

#### 1.2 LLM决策的关键优势

1. **复杂推理**：能够分析任务历史中的失败票数模式
2. **上下文理解**：综合考虑游戏状态、信念系统、历史信息
3. **策略灵活性**：根据局势动态调整策略
4. **自然语言理解**：能够理解发言内容（如果扩展）

#### 1.3 流局保护机制

**LLM投票决策中的强制检查**
```python
# 在LLM返回决策后
if vote_round >= 4:  # 第5次投票
    vote = True  # 强制同意，避免流局
```

**System Prompt中的提醒**
```
重要提醒：
- 如果这是第5次投票（vote_round >= 4），好人必须同意
- 如果这是第4次投票（vote_round >= 3），好人应该更倾向于同意
```

### 2. 发言生成逻辑

**所有发言均由LLM生成**

- LLM根据游戏状态、信念系统、任务历史生成发言
- 考虑最近发言内容
- 体现人格特质
- 符合角色身份和阵营目标
- 生成自然、有策略性的中文发言

---

## 游戏流程

### 完整游戏循环

```
1. 初始化阶段
   ├─ 创建游戏引擎
   ├─ 分配角色
   ├─ 初始化智能体
   └─ 设置初始状态

2. 讨论阶段 (DISCUSSION)
   ├─ 所有玩家依次发言（从队长的下一位开始）
   ├─ 队长最后发言
   └─ 队长根据讨论决定队伍

3. 投票阶段 (VOTING)
   ├─ 所有玩家对提议的队伍投票
   ├─ 统计投票结果
   ├─ 通过 → 进入任务执行阶段
   └─ 未通过 → 增加投票轮次，更换队长，回到讨论阶段

4. 任务执行阶段 (MISSION)
   ├─ 任务成员进行任务投票（成功/失败）
   ├─ 统计任务结果
   ├─ 更新所有智能体的信念系统
   ├─ 检查游戏结束条件
   └─ 进入下一轮或刺杀阶段

5. 刺杀阶段 (ASSASSINATION) [如果好人完成3个任务]
   ├─ 刺客选择刺杀目标
   ├─ 检查刺杀结果
   └─ 游戏结束

6. 游戏结束 (FINISHED)
   └─ 显示游戏结果和统计信息
```

### 状态转换图

```
INITIALIZATION
    ↓
DISCUSSION
    ↓
VOTING
    ├─ 通过 → MISSION
    └─ 未通过 → DISCUSSION（更换队长）
        ↓
        [如果投票轮次 >= 5] → FINISHED（坏人获胜）
    ↓
MISSION
    ├─ 成功任务 < 3 → DISCUSSION（下一轮）
    ├─ 成功任务 = 3 → ASSASSINATION
    └─ 失败任务 = 3 → FINISHED（坏人获胜）
    ↓
ASSASSINATION
    ├─ 刺杀成功 → FINISHED（坏人获胜）
    └─ 刺杀失败 → FINISHED（好人获胜）
    ↓
FINISHED
```

---

## 信息流与状态管理

### 1. 信息流

```
游戏引擎 (GameEngine)
    ↓
get_game_state_summary(player_id)
    ├─ 基础游戏状态（所有玩家共享）
    │   ├─ 当前阶段
    │   ├─ 当前轮次
    │   ├─ 成功/失败任务数
    │   ├─ 任务历史
    │   └─ 投票轮次
    │
    └─ 玩家私有信息（通过InformationFilter）
        ├─ 可见玩家列表
        ├─ 角色信息
        └─ 阵营信息
    ↓
智能体 (BaseAgent)
    ├─ 信念系统更新
    ├─ 策略引擎决策
    └─ 沟通生成器生成发言
    ↓
决策结果
    ↓
游戏引擎更新状态
    ↓
下一轮循环
```

### 2. 状态同步

**游戏状态更新时机**
1. 队伍提议后：`proposed_team`更新，阶段切换到VOTING
2. 投票完成后：`votes`清空，阶段切换到MISSION或DISCUSSION
3. 任务完成后：`mission_results`更新，信念系统更新
4. 轮次切换：`current_round`增加，`current_leader`更换

**信念系统更新时机**
- 投票行为后：`update_belief_from_vote()`
- 任务结果后：`update_belief_from_mission()`
- 发言后：`update_belief_from_speech()`（当前为简化实现）

### 3. 信息不对称

**不同角色看到的信息**

| 角色 | 能看到的信息 |
|------|------------|
| 梅林 | 所有坏人（除莫德雷德、莫甘娜） |
| 派西维尔 | 梅林和莫甘娜（但分不清） |
| 忠臣 | 无特殊信息 |
| 刺客 | 所有坏人队友（除奥伯伦） |
| 莫甘娜 | 所有坏人队友（除奥伯伦） |
| 莫德雷德 | 所有坏人队友（除奥伯伦） |
| 奥伯伦 | 无特殊信息（独立） |
| 爪牙 | 所有坏人队友（除奥伯伦） |

**信息过滤实现**
- `InformationFilter.get_visible_players()`: 根据角色的`can_see()`方法
- `InformationFilter.get_private_info()`: 构建可见玩家信息字典
- 派西维尔特殊处理：显示"可能是梅林"而不是具体阵营

---

## 关键设计决策

### 1. 流局保护机制

**问题**：如果好人过度拒绝，可能导致5次投票都失败，坏人直接获胜

**解决方案**：
- 第5次投票（vote_round >= 4）：好人强制同意
- 第4次投票（vote_round >= 3）：好人更倾向于同意（30-60%概率）
- LLM决策中明确提醒流局风险

### 2. LLM策略引擎（必需）

**系统要求**：
- 必须配置LLM API（OpenAI、DeepSeek或本地Qwen）
- 所有决策均由LLM完成
- 如果LLM不可用，系统会抛出错误

**LLM引擎优势**：
- 复杂推理能力
- 上下文理解
- 策略灵活性
- 自然语言生成

### 3. 信念系统设计

**概率更新机制**：
- 使用乘法更新（×1.1, ×1.2等）
- 每次更新后归一化
- 避免概率过度极端

**信任度评分**：
- 基于阵营概率计算
- 用于排序和选择

### 4. 信息过滤设计

**分级信息**：
- 完全信息（自己）
- 部分信息（可见玩家）
- 基本信息（不可见玩家）

**派西维尔特殊处理**：
- 不直接显示阵营
- 显示"可能是梅林"标记
- 增加游戏策略深度

---

## 扩展点

### 1. 可扩展的角色系统
- 新增角色只需在`roles.py`中定义
- 实现`can_see()`方法定义可见性

### 2. 可扩展的策略引擎
- 可以添加新的策略引擎（如强化学习）
- 通过`BaseAgent`的统一接口调用

### 3. 可扩展的信念更新
- 可以添加更多信念更新规则
- 可以添加发言分析（NLP）

### 4. LangGraph集成
- 可选的状态图管理
- 更清晰的状态流转
- 更好的可扩展性

---

## 总结

本系统通过以下设计实现了智能的阿瓦隆游戏：

1. **多智能体架构**：每个玩家独立的智能体实例
2. **动态信念系统**：基于贝叶斯推理实时更新判断
3. **LLM策略引擎**：所有决策均由大语言模型完成，提供智能推理和策略灵活性
4. **信息过滤机制**：严格的信息不对称实现
5. **流局保护机制**：避免策略漏洞

系统设计注重：
- **模块化**：各模块职责清晰，易于扩展
- **可配置性**：支持多种LLM提供商（OpenAI、DeepSeek、本地Qwen）
- **智能决策**：LLM分析游戏状态、信念系统、任务历史，做出复杂推理
- **策略深度**：信念系统、任务历史分析、自然语言生成

**重要变更**：
- 系统现在**仅支持LLM策略引擎**，不再提供规则引擎
- 必须配置LLM API才能运行系统
- 所有决策（队伍提议、投票、任务投票、刺杀、发言）均由LLM完成

这使得智能体能够展现出类似人类玩家的策略深度和适应性，通过LLM的复杂推理能力实现更智能的游戏体验。

